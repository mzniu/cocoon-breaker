<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cocoon Breaker - AIæ—¥æŠ¥ç”Ÿæˆ</title>
    <link rel="icon" type="image/svg+xml" href="/static/images/logo.svg">
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <!-- html2canvas for PNG export with multiple CDN fallbacks -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" 
            integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA==" 
            crossorigin="anonymous" 
            referrerpolicy="no-referrer"
            onerror="this.onerror=null; this.src='https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js';"></script>
</head>
<body>
    <div id="app">
        <!-- Header -->
        <header class="header">
            <div class="container">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h1 class="logo">
                            <img src="/static/images/logo.svg" alt="Cocoon Breaker" class="logo-icon">
                            Cocoon Breaker
                        </h1>
                        <p class="tagline">æ‰“ç ´ä¿¡æ¯èŒ§æˆ¿ï¼ŒAIé©±åŠ¨çš„ä¸ªæ€§åŒ–æ—¥æŠ¥</p>
                    </div>
                    <a href="/articles.html" style="color: white; text-decoration: none; font-size: 16px; padding: 10px 20px; background: rgba(255,255,255,0.2); border-radius: 4px; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                        ğŸ“š æµè§ˆæ–‡ç« 
                    </a>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="container">
            <!-- Subscriptions Section -->
            <section class="section">
                <div class="section-header">
                    <h2>ğŸ“š è®¢é˜…ç®¡ç†</h2>
                    <button @click="showAddDialog = true" class="btn btn-primary">
                        â• æ·»åŠ è®¢é˜…
                    </button>
                </div>
                
                <div v-if="subscriptions.length === 0" class="empty-state">
                    <p>è¿˜æ²¡æœ‰è®¢é˜…ä»»ä½•ä¸»é¢˜ï¼Œæ·»åŠ ä¸€ä¸ªå¼€å§‹å§ï¼</p>
                </div>
                
                <div v-else class="subscriptions-grid">
                    <div v-for="sub in subscriptions" :key="sub.id" class="subscription-card">
                        <div class="card-content">
                            <h3>{{ sub.keyword }}</h3>
                            <p class="meta">åˆ›å»ºäº {{ formatDate(sub.created_at) }}</p>
                        </div>
                        <div class="card-actions">
                            <button 
                                @click="toggleSubscription(sub)" 
                                :class="['btn-toggle', sub.enabled ? 'active' : '']"
                                :title="sub.enabled ? 'ç¦ç”¨' : 'å¯ç”¨'"
                            >
                                {{ sub.enabled ? 'âœ“' : 'âœ—' }}
                            </button>
                            <button 
                                @click="deleteSubscription(sub.id)" 
                                class="btn-delete"
                                title="åˆ é™¤"
                            >
                                ğŸ—‘
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Reports Section -->
            <section class="section">
                <div class="section-header">
                    <h2>ğŸ“° æ—¥æŠ¥åˆ—è¡¨</h2>
                    <div style="display: flex; gap: 10px;">
                        <button @click="collectArticles" :disabled="collecting" class="btn btn-secondary">
                            {{ collecting ? 'æœé›†ä¸­...' : 'ğŸ“¥ æœé›†èµ„è®¯' }}
                        </button>
                        <button @click="generateReport" :disabled="generating" class="btn btn-primary">
                            {{ generating ? 'ç”Ÿæˆä¸­...' : 'âš¡ ç«‹å³ç”Ÿæˆ' }}
                        </button>
                    </div>
                    </button>
                </div>
                
                <div v-if="reports.length === 0" class="empty-state">
                    <p>è¿˜æ²¡æœ‰ç”Ÿæˆä»»ä½•æ—¥æŠ¥</p>
                </div>
                
                <div v-else class="reports-grid">
                    <div v-for="report in reports" :key="report.id" class="report-card">
                        <div class="card-content">
                            <h3>{{ report.keyword }}</h3>
                            <p class="meta">
                                ğŸ“… {{ report.date }}<br>
                                ğŸ“Š {{ report.article_count }} ç¯‡æ–‡ç« <br>
                                ğŸ•’ {{ formatDateTime(report.generated_at) }}
                            </p>
                        </div>
                        <div class="card-actions">
                            <button @click="viewReport(report)" class="btn btn-view">
                                æŸ¥çœ‹
                            </button>
                            <button @click="downloadReport(report.id)" class="btn btn-download">
                                ä¸‹è½½
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Schedule Section -->
            <section class="section">
                <div class="section-header">
                    <h2>â° å®šæ—¶è®¾ç½®</h2>
                </div>
                
                <div class="schedule-config">
                    <div class="form-group">
                        <label>ç”Ÿæˆæ—¶é—´</label>
                        <input 
                            type="time" 
                            v-model="schedule.time" 
                            @change="updateSchedule"
                            class="input-time"
                        >
                    </div>
                    <div class="form-group">
                        <label>
                            <input 
                                type="checkbox" 
                                v-model="schedule.enabled" 
                                @change="updateSchedule"
                            >
                            å¯ç”¨å®šæ—¶ç”Ÿæˆ
                        </label>
                    </div>
                    <p class="schedule-info">
                        {{ schedule.enabled ? `æ¯å¤© ${schedule.time} è‡ªåŠ¨ç”Ÿæˆæ—¥æŠ¥` : 'å®šæ—¶ç”Ÿæˆå·²ç¦ç”¨' }}
                    </p>
                </div>
            </section>
        </div>

        <!-- Add Subscription Dialog -->
        <div v-if="showAddDialog" class="modal-overlay" @click.self="showAddDialog = false">
            <div class="modal">
                <h3>æ·»åŠ è®¢é˜…</h3>
                <form @submit.prevent="addSubscription">
                    <div class="form-group">
                        <label>å…³é”®è¯</label>
                        <input 
                            type="text" 
                            v-model="newKeyword" 
                            placeholder="ä¾‹å¦‚: AI, Python, åŒºå—é“¾"
                            maxlength="50"
                            required
                            class="input"
                        >
                    </div>
                    <div class="modal-actions">
                        <button type="button" @click="showAddDialog = false" class="btn">
                            å–æ¶ˆ
                        </button>
                        <button type="submit" class="btn btn-primary">
                            æ·»åŠ 
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Report Viewer Modal -->
        <div v-if="viewingReport" class="modal-overlay" @click.self="viewingReport = null">
            <div class="modal modal-large">
                <div class="modal-header">
                    <div class="modal-header-left">
                        <h3>{{ viewingReport.keyword }} - {{ viewingReport.date }}</h3>
                    </div>
                    <div class="modal-header-right">
                        <button @click="downloadReportHtml(viewingReport.id)" class="btn-download">
                            ğŸ“„ ä¸‹è½½HTML
                        </button>
                        <button @click="downloadReportAsPng(viewingReport.id)" class="btn-download">
                            ğŸ–¼ï¸ ä¸‹è½½ä¸ºPNG
                        </button>
                        <button @click="viewingReport = null" class="btn-close">âœ•</button>
                    </div>
                </div>
                <iframe 
                    ref="reportIframe"
                    :src="`/api/reports/${viewingReport.id}/view`"
                    class="report-iframe"
                ></iframe>
            </div>
        </div>

        <!-- Notification Toast -->
        <div v-if="notification" :class="['notification', notification.type]">
            {{ notification.message }}
        </div>

        <!-- Log Panel -->
        <div class="log-panel" :class="{ 'collapsed': logCollapsed }">
            <div class="log-header" @click="logCollapsed = !logCollapsed">
                <div class="log-title">
                    <span>ğŸ“‹ æ“ä½œæ—¥å¿—</span>
                    <span class="log-count">({{ logs.length }})</span>
                </div>
                <button class="log-toggle">{{ logCollapsed ? 'å±•å¼€' : 'æ”¶èµ·' }}</button>
            </div>
            <div v-if="!logCollapsed" class="log-content">
                <div class="log-actions">
                    <button @click="clearLogs" class="btn-clear-logs">ğŸ—‘ï¸ æ¸…ç©º</button>
                    <button @click="autoScroll = !autoScroll" :class="['btn-auto-scroll', { active: autoScroll }]">
                        {{ autoScroll ? 'ğŸ“Œ è‡ªåŠ¨æ»šåŠ¨' : 'ğŸ“ åœæ­¢æ»šåŠ¨' }}
                    </button>
                </div>
                <div class="log-list" ref="logList">
                    <div v-if="logs.length === 0" class="log-empty">
                        æš‚æ— æ—¥å¿—
                    </div>
                    <div 
                        v-for="(log, index) in logs" 
                        :key="index" 
                        :class="['log-item', `log-${log.level}`]">
                        <span class="log-time">{{ log.time }}</span>
                        <span class="log-level">{{ log.levelText }}</span>
                        <span class="log-message">{{ log.message }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/app.js"></script>
</body>
</html>
